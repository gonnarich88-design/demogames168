<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î ‚Äî ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ö‡∏≠‡∏ó Co168</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0f1419;
      --surface: #1a2332;
      --surface-hover: #243044;
      --border: #2d3a4d;
      --text: #e6edf3;
      --text-muted: #8b9cb6;
      --accent: #f59e0b;
      --accent-soft: rgba(245, 158, 11, 0.15);
      --success: #10b981;
      --danger: #ef4444;
    }
    * { box-sizing: border-box; }
    body {
      font-family: 'Outfit', system-ui, sans-serif;
      margin: 0;
      min-height: 100vh;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
    }
    .layout {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1.5rem;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border);
    }
    h1 {
      font-size: 1.5rem;
      font-weight: 700;
      margin: 0;
      letter-spacing: -0.02em;
    }
    .period-tabs {
      display: flex;
      gap: 0.25rem;
      background: var(--surface);
      padding: 0.25rem;
      border-radius: 10px;
      border: 1px solid var(--border);
    }
    .period-tabs button {
      font-family: inherit;
      font-size: 0.875rem;
      font-weight: 500;
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 8px;
      background: transparent;
      color: var(--text-muted);
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
    }
    .period-tabs button:hover {
      color: var(--text);
      background: var(--surface-hover);
    }
    .period-tabs button.active {
      background: var(--accent-soft);
      color: var(--accent);
    }
    .btn-refresh {
      font-family: inherit;
      font-size: 0.875rem;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text);
      cursor: pointer;
      transition: background 0.2s;
    }
    .btn-refresh:hover {
      background: var(--surface-hover);
    }
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .stat-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.25rem;
      transition: border-color 0.2s;
    }
    .stat-card:hover {
      border-color: var(--accent);
    }
    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      letter-spacing: -0.03em;
      color: var(--accent);
      line-height: 1.2;
    }
    .stat-label {
      font-size: 0.8125rem;
      color: var(--text-muted);
      margin-top: 0.25rem;
    }
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.25rem;
      margin-bottom: 1.5rem;
    }
    .card h2 {
      font-size: 0.9375rem;
      font-weight: 600;
      margin: 0 0 1rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .by-action {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
    }
    .action-chip {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0.75rem;
      background: var(--surface-hover);
      border-radius: 8px;
      font-size: 0.875rem;
      border: 1px solid var(--border);
    }
    .action-chip span:last-child {
      font-weight: 600;
      color: var(--accent);
    }
    .table-wrap {
      overflow-x: auto;
      border-radius: 8px;
      border: 1px solid var(--border);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.875rem;
    }
    th, td {
      padding: 0.75rem 1rem;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }
    th {
      font-weight: 600;
      color: var(--text-muted);
      background: var(--surface-hover);
    }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: var(--surface-hover); }
    .pagination {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-top: 1rem;
      flex-wrap: wrap;
    }
    .pagination button {
      font-family: inherit;
      font-size: 0.875rem;
      padding: 0.5rem 0.75rem;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text);
      cursor: pointer;
    }
    .pagination button:hover:not(:disabled) {
      background: var(--surface-hover);
    }
    .pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .loading { color: var(--text-muted); }
    .error { color: var(--danger); }
    .empty { color: var(--text-muted); font-style: italic; }
    .muted { color: var(--text-muted); }
    .last-updated { font-size: 0.75rem; color: var(--text-muted); margin-top: 0.5rem; }
    .export-btns { display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .export-btns button { font-family: inherit; font-size: 0.8125rem; padding: 0.5rem 0.75rem; border-radius: 6px; border: 1px solid var(--border); background: var(--surface-hover); color: var(--text); cursor: pointer; }
    .export-btns button:hover { background: var(--accent-soft); color: var(--accent); }
    .chart-bar-wrap { display: flex; align-items: flex-end; gap: 4px; height: 120px; margin-top: 0.5rem; }
    .chart-bar { flex: 1; min-width: 0; background: var(--accent-soft); border-radius: 4px 4px 0 0; min-height: 4px; transition: height 0.2s; }
    .chart-bar:hover { background: var(--accent); }
    .chart-labels { display: flex; gap: 4px; margin-top: 0.25rem; font-size: 0.7rem; color: var(--text-muted); }
    .chart-labels span { flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; text-align: center; }
    .calendar-wrap {
      display: flex;
      flex-wrap: wrap;
      gap: 1.25rem;
      align-items: flex-start;
    }
    .calendar-main {
      flex: 0 0 320px;
    }
    .calendar-side {
      flex: 1;
      min-width: 220px;
      background: var(--surface-hover);
      border-radius: 12px;
      padding: 0.85rem 1rem;
      border: 1px dashed var(--border);
    }
    .calendar-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.75rem; }
    .calendar-header button { font-family: inherit; padding: 0.35rem 0.75rem; border-radius: 6px; border: 1px solid var(--border); background: var(--surface-hover); color: var(--text); cursor: pointer; font-size: 0.875rem; }
    .calendar-header button:hover { background: var(--accent-soft); color: var(--accent); }
    .calendar-month { font-weight: 600; font-size: 0.9375rem; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; font-size: 0.75rem; }
    .calendar-cell { padding: 0.4rem 0.25rem; text-align: center; border-radius: 7px; min-height: 46px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; border: 1px solid transparent; position: relative; }
    .calendar-cell.head { color: var(--text-muted); font-weight: 600; cursor: default; }
    .calendar-cell.empty { visibility: hidden; cursor: default; }
    .calendar-cell.day:hover { background: var(--surface-hover); border-color: var(--border); }
    .calendar-cell.day.selected { background: var(--accent-soft); color: var(--accent); border-color: var(--accent); box-shadow: 0 0 0 1px rgba(245,158,11,0.5); }
    .calendar-cell .day-number { font-size: 0.8rem; font-weight: 500; }
    .calendar-cell .count-pill {
      margin-top: 3px;
      padding: 0 0.45rem;
      border-radius: 999px;
      font-size: 0.65rem;
      background: var(--surface);
      color: var(--text-muted);
      white-space: nowrap;
    }
    .calendar-cell.day.zero .count-pill { opacity: 0.3; }
    .calendar-cell.day.low:not(.selected) .count-pill { background: rgba(245, 158, 11, 0.18); color: var(--accent); }
    .calendar-cell.day.mid:not(.selected) .count-pill { background: rgba(245, 158, 11, 0.32); color: var(--accent); }
    .calendar-cell.day.high:not(.selected) .count-pill { background: rgba(245, 158, 11, 0.55); color: #0b1120; font-weight: 600; }
    .calendar-cell.day.selected .count-pill { background: rgba(245, 158, 11, 0.2); color: var(--accent); }
    .selected-date-bar { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem; padding: 0.75rem; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; flex-wrap: wrap; }
    .selected-date-bar span { font-weight: 500; }
    .selected-date-bar button { font-family: inherit; font-size: 0.8125rem; padding: 0.35rem 0.6rem; border-radius: 6px; border: 1px solid var(--border); background: var(--surface-hover); color: var(--text-muted); cursor: pointer; }
    .selected-date-bar button:hover { color: var(--accent); }
    .range-tabs { display: flex; gap: 0.25rem; margin-bottom: 0.75rem; flex-wrap: wrap; }
    .range-tabs button {
      font-family: inherit; font-size: 0.8125rem; padding: 0.4rem 0.85rem; border-radius: 8px; border: 1px solid var(--border);
      background: var(--surface); color: var(--text-muted); cursor: pointer; transition: background 0.2s, color 0.2s, border-color 0.2s;
    }
    .range-tabs button:hover { background: var(--surface-hover); color: var(--text); }
    .range-tabs button.active { background: var(--accent-soft); color: var(--accent); border-color: var(--accent); }
    .range-picker-wrap { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem; flex-wrap: wrap; }
    .range-picker-wrap label { font-size: 0.8125rem; color: var(--text-muted); }
    .range-picker-wrap select {
      font-family: inherit; font-size: 0.875rem; padding: 0.4rem 0.6rem; border-radius: 6px; border: 1px solid var(--border);
      background: var(--surface); color: var(--text); min-width: 160px;
    }
    .calendar-side-title {
      font-size: 0.875rem;
      font-weight: 600;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      color: var(--text-muted);
      margin-bottom: 0.4rem;
    }
    .calendar-side-text {
      font-size: 0.8125rem;
      margin: 0.1rem 0 0.5rem;
    }
    .calendar-side-highlight {
      margin-top: 0.35rem;
      padding: 0.45rem 0.6rem;
      border-radius: 8px;
      background: rgba(15,23,42,0.7);
      border: 1px solid var(--border);
    }
    .calendar-side-highlight .label {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-bottom: 0.1rem;
    }
    .calendar-side-highlight .value {
      font-size: 0.875rem;
      font-weight: 500;
    }
    .calendar-side-highlight .value span {
      font-size: 0.75rem;
      color: var(--accent);
      margin-left: 0.25rem;
    }
    .calendar-side-hint {
      font-size: 0.75rem;
      margin-top: 0.5rem;
    }
    .calendar-legend {
      margin-top: 0.5rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem 0.9rem;
      font-size: 0.7rem;
      color: var(--text-muted);
    }
    .calendar-legend-item {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
    }
    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      display: inline-block;
    }
    .legend-none { border: 1px solid var(--border); background: transparent; }
    .legend-low { background: rgba(245, 158, 11, 0.18); }
    .legend-mid { background: rgba(245, 158, 11, 0.32); }
    .legend-high { background: rgba(245, 158, 11, 0.55); }
  </style>
</head>
<body>
  <div class="layout">
    <header>
      <h1>üìä ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ö‡∏≠‡∏ó Co168</h1>
      <div style="display:flex; align-items:center; gap:1rem;">
        <div class="period-tabs" role="tablist">
          <button type="button" data-period="all" class="active">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
          <button type="button" data-period="day">24 ‡∏ä‡∏°.</button>
          <button type="button" data-period="week">7 ‡∏ß‡∏±‡∏ô</button>
          <button type="button" data-period="month">30 ‡∏ß‡∏±‡∏ô</button>
        </div>
        <button type="button" class="btn-refresh" id="btnRefresh">‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà</button>
      </div>
    </header>
    <p class="last-updated" id="lastUpdated">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏°‡∏∑‡πà‡∏≠: ‚Äì</p>

    <div id="selectedDateBar" class="selected-date-bar" style="display:none;">
      <span id="selectedRangeLabel"></span>
      <button type="button" id="btnClearRange">‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
    </div>

    <section class="card">
      <h2>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏î‡∏π‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</h2>
      <div class="range-tabs" role="tablist">
        <button type="button" data-range="day" id="rangeDayBtn" class="active">‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</button>
        <button type="button" data-range="week" id="rangeWeekBtn">‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</button>
        <button type="button" data-range="month" id="rangeMonthBtn">‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</button>
      </div>
      <div id="rangeDayWrap" class="range-picker-wrap">
        <label>‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô ‚Äî ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ú‡∏•‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡πâ‡∏ô</label>
      </div>
      <div id="rangeWeekWrap" class="range-picker-wrap" style="display:none;">
        <label for="weekSelect">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</label>
        <select id="weekSelect"><option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå ‚Äî</option></select>
      </div>
      <div id="rangeMonthWrap" class="range-picker-wrap" style="display:none;">
        <label for="monthSelect">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label>
        <select id="monthSelect"><option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‚Äî</option></select>
      </div>
    </section>

    <section class="card">
      <h2>‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô ‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏î‡∏π‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô</h2>
      <div class="calendar-wrap">
        <div class="calendar-main">
          <div class="calendar-header">
            <button type="button" id="calendarPrev">‚Üê ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô</button>
            <span class="calendar-month" id="calendarMonthTitle"></span>
            <button type="button" id="calendarNext">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚Üí</button>
          </div>
          <div id="calendarGrid" class="calendar-grid"></div>
          <div class="calendar-legend">
            <span class="calendar-legend-item"><span class="legend-dot legend-none"></span>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Å‡∏î</span>
            <span class="calendar-legend-item"><span class="legend-dot legend-low"></span>‡∏Å‡∏î‡∏ô‡πâ‡∏≠‡∏¢</span>
            <span class="calendar-legend-item"><span class="legend-dot legend-mid"></span>‡∏Å‡∏î‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á</span>
            <span class="calendar-legend-item"><span class="legend-dot legend-high"></span>‡∏Å‡∏î‡πÄ‡∏¢‡∏≠‡∏∞</span>
          </div>
        </div>
        <div class="calendar-side" id="calendarSide">
          <div class="calendar-side-title">‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div>
          <p class="calendar-side-text muted">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÉ‡∏ô‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á</p>
        </div>
      </div>
    </section>

    <section class="dashboard-grid">
      <div class="stat-card">
        <div class="stat-value" id="statTotal">‚Äì</div>
        <div class="stat-label">‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="statUsers">‚Äì</div>
        <div class="stat-label">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥</div>
      </div>
    </section>

    <section class="card">
      <h2>‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• <span class="muted" style="font-weight:400;text-transform:none;">(‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)</span></h2>
      <div class="export-btns">
        <button type="button" id="btnExportCsv">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î CSV</button>
        <button type="button" id="btnExportJson">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î JSON</button>
      </div>
    </section>

    <section class="card">
      <h2>‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô</h2>
      <div id="chartByDay" class="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
    </section>

    <section class="card">
      <h2>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà active ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î (Top 20)</h2>
      <div id="topUsersWrap" class="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
    </section>

    <section class="card">
      <h2>‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏° Action</h2>
      <div id="byAction" class="by-action loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
    </section>

    <section class="card">
      <h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h2>
      <div id="latestList" class="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
    </section>

    <section class="card">
      <h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÅ‡∏ö‡πà‡∏á‡∏´‡∏ô‡πâ‡∏≤)</h2>
      <div id="pagination" class="pagination"></div>
      <div class="table-wrap">
        <div id="eventsTableWrap"></div>
      </div>
    </section>
  </div>

  <script>
    const LIMIT = 50;
    let currentPeriod = 'all';
    let currentOffset = 0;
    let selectedDate = null;
    let selectedWeek = null;
    let selectedMonth = null;
    let currentRange = 'day';
    let currentCalendarMonth = '';

    function getCalendarMonth() {
      var d = new Date();
      return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0');
    }

    function setPeriod(p) {
      currentPeriod = p;
      selectedDate = null;
      selectedWeek = null;
      selectedMonth = null;
      document.getElementById('selectedDateBar').style.display = 'none';
      document.querySelectorAll('.period-tabs button').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.period === p);
      });
      loadStats();
      loadEvents(0);
    }

    function setRange(range) {
      currentRange = range;
      document.querySelectorAll('.range-tabs button').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.range === range);
      });
      document.getElementById('rangeDayWrap').style.display = range === 'day' ? 'flex' : 'none';
      document.getElementById('rangeWeekWrap').style.display = range === 'week' ? 'flex' : 'none';
      document.getElementById('rangeMonthWrap').style.display = range === 'month' ? 'flex' : 'none';
      if (range !== 'day') selectedDate = null;
      if (range !== 'week') selectedWeek = null;
      if (range !== 'month') selectedMonth = null;
      document.getElementById('selectedDateBar').style.display = 'none';
      if (range === 'week') document.getElementById('weekSelect').value = '';
      if (range === 'month') document.getElementById('monthSelect').value = '';
      loadStats();
      loadEvents(0);
      if (range === 'day') renderCalendar(currentCalendarMonth);
    }

    function setSelectedDate(dateStr) {
      selectedDate = dateStr;
      selectedWeek = null;
      selectedMonth = null;
      if (dateStr) {
        var d = new Date(dateStr + 'T12:00:00');
        document.getElementById('selectedRangeLabel').innerHTML = 'üìÖ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà <strong>' + d.toLocaleDateString('th-TH', { day: 'numeric', month: 'long', year: 'numeric' }) + '</strong>';
        document.getElementById('selectedDateBar').style.display = 'flex';
        loadStats();
        loadEvents(0);
      } else {
        document.getElementById('selectedDateBar').style.display = 'none';
      }
    }

    function setSelectedWeek(weekVal) {
      selectedWeek = weekVal || null;
      selectedDate = null;
      selectedMonth = null;
      if (weekVal) {
        var mon = new Date(weekVal + 'T12:00:00');
        var sun = new Date(mon);
        sun.setDate(mon.getDate() + 6);
        var label = mon.getDate() + '‚Äì' + sun.getDate() + ' ' + mon.toLocaleDateString('th-TH', { month: 'short', year: 'numeric' });
        document.getElementById('selectedRangeLabel').innerHTML = 'üìÖ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå <strong>' + label + '</strong>';
        document.getElementById('selectedDateBar').style.display = 'flex';
        loadStats();
        loadEvents(0);
      } else {
        document.getElementById('selectedDateBar').style.display = 'none';
      }
    }

    function setSelectedMonth(monthVal) {
      selectedMonth = monthVal || null;
      selectedDate = null;
      selectedWeek = null;
      if (monthVal) {
        var d = new Date(monthVal + '-01T12:00:00');
        var label = d.toLocaleDateString('th-TH', { month: 'long', year: 'numeric' });
        document.getElementById('selectedRangeLabel').innerHTML = 'üìÖ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏î‡∏∑‡∏≠‡∏ô <strong>' + label + '</strong>';
        document.getElementById('selectedDateBar').style.display = 'flex';
        loadStats();
        loadEvents(0);
      } else {
        document.getElementById('selectedDateBar').style.display = 'none';
      }
    }

    function fillWeekOptions() {
      var sel = document.getElementById('weekSelect');
      if (!sel || sel.options.length > 1) return;
      var weeks = [];
      var d = new Date();
      for (var i = 0; i < 16; i++) {
        var daysFromMonday = (d.getDay() + 6) % 7;
        var mon = new Date(d);
        mon.setDate(d.getDate() - daysFromMonday - i * 7);
        var sun = new Date(mon);
        sun.setDate(mon.getDate() + 6);
        var monStr = mon.getFullYear() + '-' + String(mon.getMonth() + 1).padStart(2, '0') + '-' + String(mon.getDate()).padStart(2, '0');
        var label = mon.getDate() + '‚Äì' + sun.getDate() + ' ' + mon.toLocaleDateString('th-TH', { month: 'short', year: 'numeric' });
        weeks.push({ value: monStr, label: label });
      }
      weeks.forEach(function(w) {
        var opt = document.createElement('option');
        opt.value = w.value;
        opt.textContent = w.label;
        sel.appendChild(opt);
      });
    }

    function fillMonthOptions() {
      var sel = document.getElementById('monthSelect');
      if (!sel || sel.options.length > 1) return;
      var d = new Date();
      for (var i = 0; i < 12; i++) {
        var m = new Date(d.getFullYear(), d.getMonth() - i, 1);
        var ym = m.getFullYear() + '-' + String(m.getMonth() + 1).padStart(2, '0');
        var label = m.toLocaleDateString('th-TH', { month: 'long', year: 'numeric' });
        var opt = document.createElement('option');
        opt.value = ym;
        opt.textContent = label;
        sel.appendChild(opt);
      }
    }

    function renderCalendar(month) {
      currentCalendarMonth = month;
      var title = new Date(month + '-01T12:00:00').toLocaleDateString('th-TH', { month: 'long', year: 'numeric' });
      document.getElementById('calendarMonthTitle').textContent = title;
      fetch('/api/bot-stats-month?month=' + month).then(function(r) { return r.json(); }).then(function(data) {
        var byDayMap = {};
        if (data.byDay) data.byDay.forEach(function(d) { byDayMap[d.date] = d.count; });
        var y = parseInt(month.slice(0,4), 10);
        var m = parseInt(month.slice(5,7), 10) - 1;
        var first = new Date(y, m, 1);
        var daysInMonth = new Date(y, m + 1, 0).getDate();
        var startWeekday = first.getDay();
        var cells = [];
        var weekDays = ['‡∏≠‡∏≤','‡∏à','‡∏≠','‡∏û','‡∏û‡∏§','‡∏®','‡∏™'];
        weekDays.forEach(function(w) { cells.push({ head: true, label: w }); });
        for (var i = 0; i < startWeekday; i++) cells.push({ empty: true });
        for (var d = 1; d <= daysInMonth; d++) {
          var dateStr = month + '-' + String(d).padStart(2, '0');
          cells.push({ date: dateStr, day: d, count: byDayMap[dateStr] || 0 });
        }

        var html = cells.map(function(c) {
          if (c.head) return '<div class="calendar-cell head">' + c.label + '</div>';
          if (c.empty) return '<div class="calendar-cell empty"></div>';
          var sel = c.date === selectedDate ? ' selected' : '';
          var levelClass = ' zero';
          if (c.count > 0 && c.count <= 5) levelClass = ' low';
          else if (c.count > 5 && c.count <= 20) levelClass = ' mid';
          else if (c.count > 20) levelClass = ' high';
          var titleCell = c.date + ': ' + c.count + ' ‡∏Ñ‡∏£‡∏±‡πâ‡∏á';
          var countLabel = c.count === 0 ? '0' : c.count;
          return '<div class="calendar-cell day' + sel + levelClass + '" data-date="' + c.date + '" title="' + titleCell + '">'
            + '<div class="day-number">' + c.day + '</div>'
            + '<div class="count-pill">' + countLabel + '</div>'
            + '</div>';
        }).join('');
        document.getElementById('calendarGrid').innerHTML = html;

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏£‡∏∏‡∏õ‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡∏ß‡∏≤
        var totalMonth = 0;
        var maxDate = null;
        Object.keys(byDayMap).forEach(function(key) {
          var c = byDayMap[key] || 0;
          totalMonth += c;
          if (!maxDate || c > maxDate.count) {
            maxDate = { date: key, count: c };
          }
        });
        var sideEl = document.getElementById('calendarSide');
        if (sideEl) {
          if (!totalMonth) {
            sideEl.innerHTML = '<div class="calendar-side-title">‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div>'
              + '<p class="calendar-side-text muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</p>';
          } else {
            var avg = (totalMonth / daysInMonth).toFixed(1);
            var highlight = maxDate
              ? '<div class="calendar-side-highlight"><div class="label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏ô‡πÉ‡∏ä‡πâ‡πÄ‡∏¢‡∏≠‡∏∞‡∏™‡∏∏‡∏î</div><div class="value">' + maxDate.date + ' <span>(' + maxDate.count + ' ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)</span></div></div>'
              : '';
            sideEl.innerHTML = '<div class="calendar-side-title">‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div>'
              + '<p class="calendar-side-text">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <strong>' + totalMonth + '</strong> ‡∏Ñ‡∏£‡∏±‡πâ‡∏á (‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ ~' + avg + ' ‡∏Ñ‡∏£‡∏±‡πâ‡∏á/‡∏ß‡∏±‡∏ô)</p>'
              + highlight
              + '<p class="calendar-side-hint muted">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡πâ‡∏ô</p>';
          }
        }

        document.getElementById('calendarGrid').querySelectorAll('.calendar-cell.day').forEach(function(el) {
          el.addEventListener('click', function() { setSelectedDate(el.dataset.date); renderCalendar(currentCalendarMonth); });
        });
      });
    }

    function setLastUpdated() {
      var el = document.getElementById('lastUpdated');
      if (el) el.textContent = '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏°‡∏∑‡πà‡∏≠: ' + new Date().toLocaleTimeString('th-TH');
    }

    async function loadStats() {
      const totalEl = document.getElementById('statTotal');
      const usersEl = document.getElementById('statUsers');
      const byEl = document.getElementById('byAction');
      const latestEl = document.getElementById('latestList');
      const chartEl = document.getElementById('chartByDay');
      const topEl = document.getElementById('topUsersWrap');
      try {
        var q = 'period=' + currentPeriod;
        if (selectedDate) q = 'period=all&date=' + selectedDate;
        if (selectedWeek) q = 'period=all&week=' + selectedWeek;
        if (selectedMonth) q = 'period=all&month=' + selectedMonth;
        const res = await fetch('/api/bot-stats?' + q);
        const data = await res.json();
        totalEl.textContent = data.total.toLocaleString();
        usersEl.textContent = data.uniqueUsers.toLocaleString();
        setLastUpdated();
        if (data.byAction && data.byAction.length) {
          byEl.innerHTML = data.byAction.map(a =>
            '<div class="action-chip"><span>' + a.action + '</span><span>' + a.count + '</span></div>'
          ).join('');
          byEl.classList.remove('loading');
        } else {
          byEl.innerHTML = '<span class="empty">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>';
          byEl.classList.remove('loading');
        }
        if (data.byDay && data.byDay.length) {
          var maxCount = Math.max.apply(null, data.byDay.map(function(d) { return d.count; })) || 1;
          chartEl.innerHTML = '<div class="chart-bar-wrap">' + data.byDay.map(function(d) {
            return '<div class="chart-bar" style="height:' + (maxCount ? (d.count / maxCount * 100) : 0) + '%" title="' + d.date + ': ' + d.count + '"></div>';
          }).join('') + '</div><div class="chart-labels">' + data.byDay.map(function(d) { return '<span>' + d.date.slice(5) + '</span>'; }).join('') + '</div>';
          chartEl.classList.remove('loading');
        } else {
          chartEl.innerHTML = '<span class="empty">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>';
          chartEl.classList.remove('loading');
        }
        if (data.topUsers && data.topUsers.length) {
          topEl.innerHTML = '<table><thead><tr><th>#</th><th>User ID</th><th>Username</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th></tr></thead><tbody>'
            + data.topUsers.map(function(u, i) { return '<tr><td>' + (i + 1) + '</td><td>' + u.telegram_user_id + '</td><td class="muted">' + (u.username ? '@' + u.username : '‚Äì') + '</td><td>' + (u.first_name || '‚Äì') + '</td><td>' + u.count + '</td></tr>'; }).join('')
            + '</tbody></table>';
          topEl.classList.remove('loading');
        } else {
          topEl.innerHTML = '<span class="empty">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>';
          topEl.classList.remove('loading');
        }
        if (data.latest && data.latest.length) {
          latestEl.innerHTML = '<table><thead><tr><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>User ID</th><th>Username</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>Action</th></tr></thead><tbody>'
            + data.latest.map(e => '<tr><td>' + formatDate(e.created_at) + '</td><td>' + e.telegram_user_id + '</td><td class="muted">' + (e.username ? '@' + e.username : '‚Äì') + '</td><td>' + (e.first_name || '‚Äì') + '</td><td>' + e.action + '</td></tr>').join('')
            + '</tbody></table>';
          latestEl.classList.remove('loading');
        } else {
          latestEl.innerHTML = '<span class="empty">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>';
          latestEl.classList.remove('loading');
        }
      } catch (err) {
        totalEl.textContent = '‚Äì';
        usersEl.textContent = '‚Äì';
        byEl.innerHTML = '<span class="error">‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message + '</span>';
        latestEl.innerHTML = chartEl.innerHTML = topEl.innerHTML = '<span class="error">‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span>';
      }
    }

    function formatDate(iso) {
      if (!iso) return '‚Äì';
      const d = new Date(iso);
      return d.toLocaleString('th-TH', { dateStyle: 'short', timeStyle: 'short' });
    }

    async function loadEvents(offset) {
      const wrap = document.getElementById('eventsTableWrap');
      const pagEl = document.getElementById('pagination');
      try {
        var q = 'limit=' + LIMIT + '&offset=' + (offset || 0) + '&period=' + currentPeriod;
        if (selectedDate) q += '&date=' + selectedDate;
        if (selectedWeek) q += '&week=' + selectedWeek;
        if (selectedMonth) q += '&month=' + selectedMonth;
        const res = await fetch('/api/bot-events?' + q);
        const data = await res.json();
        currentOffset = data.offset;
        if (!data.events || !data.events.length) {
          wrap.innerHTML = '<table><tbody><tr><td class="empty" style="padding:2rem;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr></tbody></table>';
          pagEl.innerHTML = '';
          return;
        }
        wrap.innerHTML = '<table><thead><tr><th>#</th><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>User ID</th><th>Username</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>Action</th></tr></thead><tbody>'
          + data.events.map(e => '<tr><td>' + e.id + '</td><td>' + formatDate(e.created_at) + '</td><td>' + e.telegram_user_id + '</td><td class="muted">' + (e.username ? '@' + e.username : '‚Äì') + '</td><td>' + (e.first_name || '‚Äì') + '</td><td>' + e.action + '</td></tr>').join('')
          + '</tbody></table>';
        const prev = currentOffset - LIMIT;
        const next = currentOffset + LIMIT;
        pagEl.innerHTML = ''
          + (prev >= 0 ? '<button type="button" data-offset="' + prev + '">‚Üê ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>' : '')
          + '<span class="muted" style="font-size:0.875rem;">‡πÅ‡∏™‡∏î‡∏á ' + (currentOffset + 1) + '‚Äì' + Math.min(currentOffset + data.events.length, data.total) + ' ‡∏à‡∏≤‡∏Å ' + data.total + '</span>'
          + (next < data.total ? '<button type="button" data-offset="' + next + '">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚Üí</button>' : '');
        pagEl.querySelectorAll('button').forEach(btn => {
          btn.addEventListener('click', () => loadEvents(parseInt(btn.dataset.offset, 10)));
        });
      } catch (err) {
        wrap.innerHTML = '<span class="error">‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message + '</span>';
      }
    }

    document.querySelectorAll('.period-tabs button').forEach(btn => {
      btn.addEventListener('click', () => setPeriod(btn.dataset.period));
    });
    document.getElementById('btnRefresh').addEventListener('click', () => {
      loadStats();
      loadEvents(currentOffset);
    });
    document.getElementById('btnClearRange').addEventListener('click', function() {
      selectedDate = null;
      selectedWeek = null;
      selectedMonth = null;
      document.getElementById('selectedDateBar').style.display = 'none';
      document.getElementById('weekSelect').value = '';
      document.getElementById('monthSelect').value = '';
      loadStats();
      loadEvents(0);
      renderCalendar(currentCalendarMonth);
    });
    document.getElementById('rangeDayBtn').addEventListener('click', function() { setRange('day'); });
    document.getElementById('rangeWeekBtn').addEventListener('click', function() { setRange('week'); fillWeekOptions(); });
    document.getElementById('rangeMonthBtn').addEventListener('click', function() { setRange('month'); fillMonthOptions(); });
    document.getElementById('weekSelect').addEventListener('change', function() { setSelectedWeek(this.value || null); });
    document.getElementById('monthSelect').addEventListener('change', function() { setSelectedMonth(this.value || null); });
    document.getElementById('calendarPrev').addEventListener('click', function() {
      var [y, m] = currentCalendarMonth.split('-').map(Number);
      m--;
      if (m < 1) { m = 12; y--; }
      renderCalendar(y + '-' + String(m).padStart(2, '0'));
    });
    document.getElementById('calendarNext').addEventListener('click', function() {
      var [y, m] = currentCalendarMonth.split('-').map(Number);
      m++;
      if (m > 12) { m = 1; y++; }
      renderCalendar(y + '-' + String(m).padStart(2, '0'));
    });

    function downloadFile(filename, content, mime) {
      var a = document.createElement('a');
      a.href = 'data:' + mime + ';charset=utf-8,' + encodeURIComponent(content);
      a.download = filename;
      a.click();
    }

    document.getElementById('btnExportCsv').addEventListener('click', async function() {
      try {
        var q = 'period=' + currentPeriod;
        if (selectedDate) q += '&date=' + selectedDate;
        if (selectedWeek) q += '&week=' + selectedWeek;
        if (selectedMonth) q += '&month=' + selectedMonth;
        var res = await fetch('/api/bot-events-export?' + q);
        var data = await res.json();
        if (!data.events || !data.events.length) { alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏µ‡πâ'); return; }
        var headers = ['id','telegram_user_id','username','first_name','action','created_at'];
        var csv = headers.join(',') + '\n' + data.events.map(function(e) {
          return [e.id, e.telegram_user_id, '"' + (e.username || '').replace(/"/g,'""') + '"', '"' + (e.first_name || '').replace(/"/g,'""') + '"', e.action, e.created_at || ''].join(',');
        }).join('\n');
        var name = 'bot-events-' + (selectedDate || selectedWeek || selectedMonth || currentPeriod) + '.csv';
        downloadFile(name, '\uFEFF' + csv, 'text/csv');
      } catch (err) { alert('‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message); }
    });

    document.getElementById('btnExportJson').addEventListener('click', async function() {
      try {
        var q = 'period=' + currentPeriod;
        if (selectedDate) q += '&date=' + selectedDate;
        if (selectedWeek) q += '&week=' + selectedWeek;
        if (selectedMonth) q += '&month=' + selectedMonth;
        var res = await fetch('/api/bot-events-export?' + q);
        var data = await res.json();
        if (!data.events || !data.events.length) { alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏µ‡πâ'); return; }
        var name = 'bot-events-' + (selectedDate || selectedWeek || selectedMonth || currentPeriod) + '.json';
        downloadFile(name, JSON.stringify(data.events, null, 2), 'application/json');
      } catch (err) { alert('‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message); }
    });

    currentCalendarMonth = getCalendarMonth();
    renderCalendar(currentCalendarMonth);
    loadStats();
    loadEvents(0);
  </script>
</body>
</html>
